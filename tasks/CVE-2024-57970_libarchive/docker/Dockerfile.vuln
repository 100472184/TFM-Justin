FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    git clang lld make cmake ninja-build python3 pkg-config \
    autoconf automake libtool ca-certificates \
    zlib1g-dev liblzma-dev libbz2-dev libzstd-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src
RUN git clone https://github.com/libarchive/libarchive.git . && \
    git checkout v3.7.7

ENV CC=clang
ENV CXX=clang++
ENV CFLAGS="-O1 -g -fno-omit-frame-pointer -fsanitize=address -fsanitize-address-use-after-scope"
ENV CXXFLAGS="-O1 -g -fno-omit-frame-pointer -fsanitize=address -fsanitize-address-use-after-scope"
ENV LDFLAGS="-fsanitize=address"
ENV ASAN_OPTIONS="strict_string_checks=1:detect_invalid_pointer_pairs=2:halt_on_error=1:abort_on_error=1:detect_stack_use_after_return=1"

RUN cmake -B build -G Ninja \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_C_FLAGS="$CFLAGS" \
    -DCMAKE_CXX_FLAGS="$CXXFLAGS" \
    -DCMAKE_EXE_LINKER_FLAGS="$LDFLAGS" \
    && ninja -C build

RUN mkdir -p /opt/target/bin && \
    cp build/bin/bsdtar /opt/target/bin/

COPY harness/run.sh /harness/run.sh
RUN chmod +x /harness/run.sh

WORKDIR /work
ENTRYPOINT ["/harness/run.sh"]
