#!/bin/bash
# Test script to verify ASLR is disabled via setarch

echo "=== ASLR Verification Test ==="
echo ""

# Check if setarch exists
if ! command -v setarch >/dev/null 2>&1; then
  echo "❌ ERROR: setarch not found in container"
  exit 1
fi
echo "✅ setarch found: $(which setarch)"
echo ""

# Get architecture
ARCH="$(uname -m)"
echo "Architecture: $ARCH"
echo ""

# Test 1: Check personality flag
echo "--- Test 1: Personality flags ---"
echo -n "Without setarch: "
bash -c 'cat /proc/self/personality'
echo -n "With setarch -R: "
setarch "$ARCH" -R bash -c 'cat /proc/self/personality'
echo "(0x0 = ASLR enabled, 0x40000 = ADDR_NO_RANDOMIZE set)"
echo ""

# Test 2: Compare stack addresses across runs
echo "--- Test 2: Stack address consistency (5 runs) ---"
echo "Without setarch (should vary):"
for i in {1..5}; do
  bash -c 'echo -n "  Run '$i': "; cat /proc/self/maps | grep stack | cut -d" " -f1'
done
echo ""
echo "With setarch -R (should be identical):"
for i in {1..5}; do
  setarch "$ARCH" -R bash -c 'echo -n "  Run '$i': "; cat /proc/self/maps | grep stack | cut -d" " -f1'
done
echo ""

echo "✅ If 'With setarch' shows identical addresses → ASLR disabled correctly"
echo "❌ If addresses still vary → ASLR still active (problem)"
