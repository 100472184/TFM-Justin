#!/usr/bin/env python3
"""Create a valid TAR with GNU long linkname as base seed - SIMPLE VERSION."""
import subprocess
import tempfile
from pathlib import Path

def create_gnu_longlink_tar() -> bytes:
    """Create TAR with GNU long linkname using actual tar command."""
    
    with tempfile.TemporaryDirectory() as tmpdir:
        tmpdir = Path(tmpdir)
        
        # Create a regular file
        test_file = tmpdir / "test.txt"
        test_file.write_text("TEST\n")
        
        # Create a symlink with a VERY long target (this uses GNU longlink)
        long_target = "A" * 249  # 249 chars for the link target
        link_file = tmpdir / "link.txt"
        
        # On Windows, we can't create symlinks easily, so let's use tar directly
        # with GNU format and manually add long linkname entry
        # Actually, let's just use Docker to create the TAR
        pass
    
    # Simpler approach: Use Docker with bsdtar to create valid TAR
    print("Using Docker to create valid GNU longlink TAR...")
    
    import subprocess
    result = subprocess.run([
        "docker", "run", "--rm",
        "-v", f"{Path.cwd()}:/work",
        "alpine:latest",
        "sh", "-c",
        "cd /tmp && "
        "mkdir test && "
        f"echo 'TEST' > test/file.txt && "
        "tar --format=gnu -cf /work/base.tar -C test --transform='s,^,{}/,' file.txt".format("A" * 200)
    ], capture_output=True, text=True)
    
    if result.returncode != 0:
        print(f"Docker error: {result.stderr}")
        return None
    
    return Path("base.tar").read_bytes()

if __name__ == "__main__":
    import sys
    from pathlib import Path
    
    # Create base seed
    tar_bytes = create_gnu_longlink_tar()
    
    if not tar_bytes:
        print("âŒ Failed to create TAR")
        sys.exit(1)
    
    # Save to seeds directory
    seeds_dir = Path(__file__).parent
    output_path = seeds_dir / "base.tar"
    output_path.write_bytes(tar_bytes)
    
    print(f"âœ… Created base seed: {output_path}")
    print(f"   Size: {len(tar_bytes)} bytes")
    print(f"   Generated using GNU tar format")
    print(f"   Contains GNU long linkname (auto-generated)")
    print(f"   Ready for mutation to trigger CVE-2024-57970")
    
    # Analyze structure
    print(f"\nğŸ“‹ Structure analysis:")
    # Check for ././@LongLink
    if b'././@LongLink' in tar_bytes[0:512]:
        print("   âœ… Found GNU longlink header (type='K')")
        print(f"   Type flag at offset 156: {chr(tar_bytes[156])}")
    
    # Test with bsdtar
    print(f"\nğŸ§ª Testing with bsdtar...")
    test_result = subprocess.run(
        ["bsdtar", "-tf", str(output_path)],
        capture_output=True,
        text=True
    )
    if test_result.returncode == 0:
        print("   âœ… TAR is valid!")
        print(f"   Contents: {test_result.stdout.strip()}")
    else:
        print(f"   âš ï¸  bsdtar exit code: {test_result.returncode}")
        print(f"   stderr: {test_result.stderr}")
