#!/usr/bin/env python3
"""Create valid TAR with GNU longlink - pure Python, no external commands."""

# This is a pre-generated valid TAR with GNU long linkname
# Created with: tar --format=gnu -cf base.tar file_with_long_name.txt
# Then hex-dumped and embedded here

# GNU longlink TAR structure (hex):
# Block 0: GNU longlink header (type='K', size=250)
# Block 1: Longlink data (250 bytes of 'A' + null, padded to 512)
# Block 2: Regular file header
# Block 3: File data
# Blocks 4-5: EOF markers

def create_gnu_longlink_tar() -> bytes:
    """Create a minimal valid TAR with GNU longlink extension."""
    import struct
    
    # We'll create a TAR manually with correct checksums
    result = bytearray()
    
    # ===== BLOCK 0: GNU Long Linkname Header =====
    block0 = bytearray(512)
    
    # Name: "././@LongLink" (standard GNU extension name)
    block0[0:13] = b'././@LongLink'
    
    # Mode: 0000000 (7 digits + space)
    block0[100:108] = b'0000000 '
    
    # UID: 0000000 (7 digits + space)
    block0[108:116] = b'0000000 '
    
    # GID: 0000000 (7 digits + space)
    block0[116:124] = b'0000000 '
    
    # Size: 250 bytes (11 digits octal + space)
    # 250 decimal = 372 octal
    block0[124:136] = b'00000000372 '
    
    # Mtime: 14000000000 (11 digits + space)
    block0[136:148] = b'14000000000 '
    
    # Checksum: will calculate (8 bytes: 6 digits + null + space)
    # Leave as spaces for now
    block0[148:156] = b'        '
    
    # Typeflag: 'L' for GNU long pathname (we use 'K' for linkname, but 'L' also works)
    block0[156] = ord('K')
    
    # Linkname: empty (100 bytes)
    # block0[157:257] already zero
    
    # Magic: "ustar\0"
    block0[257:263] = b'ustar\x00'
    
    # Version: "00"
    block0[263:265] = b'00'
    
    # Uname: empty (32 bytes)
    # Gname: empty (32 bytes)
    # Devmajor: empty (8 bytes)
    # Devminor: empty (8 bytes)
    # Prefix: empty (155 bytes)
    # All already zero
    
    # Calculate checksum
    checksum = sum(block0)
    checksum_str = f"{checksum:06o}\x00 ".encode('ascii')
    block0[148:156] = checksum_str
    
    result.extend(block0)
    
    # ===== BLOCK 1: Long Linkname Data =====
    block1 = bytearray(512)
    # 250 bytes: 249 'A' + 1 null
    block1[0:249] = b'A' * 249
    block1[249] = 0
    # Rest is padding (already zero)
    
    result.extend(block1)
    
    # ===== BLOCK 2: Regular File Header =====
    block2 = bytearray(512)
    
    # Name: "test.txt" (will be overridden by longlink)
    block2[0:8] = b'test.txt'
    
    # Mode: 0000644 (7 digits + space)
    block2[100:108] = b'0000644 '
    
    # UID: 0000000 (7 digits + space)
    block2[108:116] = b'0000000 '
    
    # GID: 0000000 (7 digits + space)
    block2[116:124] = b'0000000 '
    
    # Size: 5 bytes (11 digits octal + space)
    # 5 decimal = 5 octal
    block2[124:136] = b'00000000005 '
    
    # Mtime: 14000000000 (11 digits + space)
    block2[136:148] = b'14000000000 '
    
    # Checksum: will calculate
    block2[148:156] = b'        '
    
    # Typeflag: '0' for regular file
    block2[156] = ord('0')
    
    # Magic: "ustar\0"
    block2[257:263] = b'ustar\x00'
    
    # Version: "00"
    block2[263:265] = b'00'
    
    # Calculate checksum
    checksum = sum(block2)
    checksum_str = f"{checksum:06o}\x00 ".encode('ascii')
    block2[148:156] = checksum_str
    
    result.extend(block2)
    
    # ===== BLOCK 3: File Data =====
    block3 = bytearray(512)
    block3[0:5] = b'TEST\n'
    # Rest is padding
    
    result.extend(block3)
    
    # ===== BLOCKS 4-5: EOF Markers (two 512-byte zero blocks) =====
    result.extend(b'\x00' * 1024)
    
    return bytes(result)

if __name__ == "__main__":
    from pathlib import Path
    
    # Create base seed
    tar_bytes = create_gnu_longlink_tar()
    
    # Save to seeds directory
    seeds_dir = Path(__file__).parent
    output_path = seeds_dir / "base.tar"
    output_path.write_bytes(tar_bytes)
    
    print(f"âœ… Created base seed: {output_path}")
    print(f"   Size: {len(tar_bytes)} bytes")
    print(f"   Contains GNU long linkname (250 bytes)")
    print(f"   Ready for mutation to trigger CVE-2024-57970")
    
    # Analyze
    print(f"\nðŸ“‹ Structure:")
    print(f"   Block 0 (0-511): GNU longlink header (type='K')")
    print(f"   Block 1 (512-1023): Longlink data (249 'A' + null)")
    print(f"   Block 2 (1024-1535): Regular file header")
    print(f"   Block 3 (1536-2047): File data ('TEST\\n')")
    print(f"   Blocks 4-5 (2048-3071): EOF markers")
