#!/usr/bin/env python3
"""Test creating a minimal valid TAR."""
import subprocess
import tempfile
from pathlib import Path

# Create a test file
with tempfile.TemporaryDirectory() as tmpdir:
    test_file = Path(tmpdir) / "test.txt"
    test_file.write_text("Hello\n")
    
    # Create TAR using system tar
    tar_path = Path("test_valid.tar")
    subprocess.run(["tar", "-cf", str(tar_path), "-C", tmpdir, "test.txt"], check=True)
    
    # Read and print first 512 bytes in hex
    data = tar_path.read_bytes()
    print(f"Created TAR: {len(data)} bytes")
    
    # Print header fields
    null = b'\x00'
    print(f"\nHeader analysis:")
    print(f"  Name: {data[0:100].split(null)[0].decode()}")
    print(f"  Mode: {data[100:108].decode()}")
    print(f"  Size: {data[124:136].decode()}")
    print(f"  Checksum: {data[148:156].decode()}")
    print(f"  Type: {chr(data[156])}")
    print(f"  Magic: {data[257:263]}")
    
    # Verify checksum
    header = bytearray(data[0:512])
    chk_field = header[148:156]
    header[148:156] = b'        '
    calc_sum = sum(header)
    stored_chk = int(chk_field.split(null)[0], 8)
    print(f"\n  Stored checksum: {stored_chk} (octal: {chk_field})")
    print(f"  Calculated checksum: {calc_sum}")
    print(f"  Match: {stored_chk == calc_sum}")
