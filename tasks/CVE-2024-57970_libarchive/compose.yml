services:
  target-vuln:
    image: cvebench/cve-2024-57970_libarchive:vuln
    build:
      context: .
      dockerfile: docker/Dockerfile.vuln
    environment:
      - TARGET_BIN=/opt/target/bin/bsdtar
      - TZ=UTC
      - LANG=C
      - LC_ALL=C
    # ASLR cannot be disabled: Docker Desktop (Windows/WSL2) does not support sysctls
    # Requires Docker native on Linux (not Desktop) for kernel.randomize_va_space=0
    # Pipeline uses 3/5 crash threshold to handle heap non-determinism
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    cap_add:
      - SYS_PTRACE
    network_mode: none
    mem_limit: 512m
    cpus: 1.0

  target-fixed:
    image: cvebench/cve-2024-57970_libarchive:fixed
    build:
      context: .
      dockerfile: docker/Dockerfile.fixed
    environment:
      - TARGET_BIN=/opt/target/bin/bsdtar
      - TZ=UTC
      - LANG=C
      - LC_ALL=C
    # ASLR cannot be disabled: Docker Desktop (Windows/WSL2) does not support sysctls
    # Requires Docker native on Linux (not Desktop) for kernel.randomize_va_space=0
    # Pipeline uses 3/5 crash threshold to handle heap non-determinism
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    cap_add:
      - SYS_PTRACE
    network_mode: none
    mem_limit: 512m
    cpus: 1.0
