services:
  target-vuln:
    image: cvebench/cve-2024-57970_libarchive:vuln
    build:
      context: .
      dockerfile: docker/Dockerfile.vuln
    environment:
      - TARGET_BIN=/opt/target/bin/bsdtar
      - TZ=UTC
      - LANG=C
      - LC_ALL=C
    # ASLR: Disabled per-process via setarch -R in harness/run.sh
    # Cannot use container sysctls (kernel.randomize_va_space not namespaced)
    # Pipeline uses 3/5 crash threshold for remaining heap non-determinism
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    cap_add:
      - SYS_PTRACE
    network_mode: none
    mem_limit: 512m
    cpus: 1.0

  target-fixed:
    image: cvebench/cve-2024-57970_libarchive:fixed
    build:
      context: .
      dockerfile: docker/Dockerfile.fixed
    environment:
      - TARGET_BIN=/opt/target/bin/bsdtar
      - TZ=UTC
      - LANG=C
      - LC_ALL=C
    # ASLR: Disabled per-process via setarch -R in harness/run.sh
    # Cannot use container sysctls (kernel.randomize_va_space not namespaced)
    # Pipeline uses 3/5 crash threshold for remaining heap non-determinism
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    cap_add:
      - SYS_PTRACE
    network_mode: none
    mem_limit: 512m
    cpus: 1.0
