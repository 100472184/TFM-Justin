#!/usr/bin/env bash
set -uo pipefail
# Note: removed -e to allow setarch to fail gracefully

export ASAN_OPTIONS="${ASAN_OPTIONS:-abort_on_error=1:detect_leaks=0:strict_string_checks=1:detect_invalid_pointer_pairs=2:halt_on_error=1:detect_stack_use_after_return=1}"
export UBSAN_OPTIONS="${UBSAN_OPTIONS:-halt_on_error=1:print_stacktrace=1}"

SEED="/input/seed.bin"
if [[ ! -f "$SEED" ]]; then
  echo "Seed not found at $SEED" >&2
  exit 2
fi

BIN="${TARGET_BIN:-/opt/target/bin/jq}"
if [[ ! -x "$BIN" ]]; then
  echo "Target binary not found or not executable: $BIN" >&2
  exit 3
fi

# Try to disable ASLR for this process, but fall back if it fails
# (setarch may fail in containers without CAP_SYS_ADMIN)
ARCH="$(uname -m)"
if command -v setarch >/dev/null 2>&1; then
  timeout 10s setarch "$ARCH" -R "$BIN" . "$SEED" 2>&1 || {
    # If setarch failed, run without ASLR disable
    timeout 10s "$BIN" . "$SEED" 2>&1
  }
else
  timeout 10s "$BIN" . "$SEED" 2>&1
fi
