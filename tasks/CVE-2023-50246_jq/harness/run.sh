#!/usr/bin/env bash
set -uo pipefail

# ASan: abort fast without trying to symbolize stack traces
export ASAN_OPTIONS="abort_on_error=1:halt_on_error=1:fast_unwind_on_fatal=1:symbolize=0"

# UBSan: DO NOT halt - jq 1.7 has inherent UBSan issues with any input
export UBSAN_OPTIONS="halt_on_error=0:print_stacktrace=0:symbolize=0"

SEED="/input/seed.bin"
if [[ ! -f "$SEED" ]]; then
  echo "Seed not found at $SEED" >&2
  exit 2
fi

BIN="${TARGET_BIN:-/opt/target/bin/jq}"
if [[ ! -x "$BIN" ]]; then
  echo "Target binary not found or not executable: $BIN" >&2
  exit 3
fi

# Run jq directly
"$BIN" . "$SEED" 2>&1
