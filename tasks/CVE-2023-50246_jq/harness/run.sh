#!/usr/bin/env bash
set -uo pipefail

# ASan/UBSan options that ensure immediate abort on any error
# Set directly (not with ${:-} syntax) to ensure they take effect
export ASAN_OPTIONS="abort_on_error=1:halt_on_error=1:allocator_may_return_null=1:detect_leaks=0"
export UBSAN_OPTIONS="halt_on_error=1:print_stacktrace=1"

SEED="/input/seed.bin"
if [[ ! -f "$SEED" ]]; then
  echo "Seed not found at $SEED" >&2
  exit 2
fi

BIN="${TARGET_BIN:-/opt/target/bin/jq}"
if [[ ! -x "$BIN" ]]; then
  echo "Target binary not found or not executable: $BIN" >&2
  exit 3
fi

# Run jq directly (setarch not needed for this CVE, causes permission issues)
timeout 10s "$BIN" . "$SEED" 2>&1
