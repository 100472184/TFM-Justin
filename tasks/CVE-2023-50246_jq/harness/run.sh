#!/usr/bin/env bash
set -euo pipefail

export ASAN_OPTIONS="${ASAN_OPTIONS:-abort_on_error=1:detect_leaks=0:strict_string_checks=1:detect_invalid_pointer_pairs=2:halt_on_error=1:detect_stack_use_after_return=1}"
export UBSAN_OPTIONS="${UBSAN_OPTIONS:-halt_on_error=1:print_stacktrace=1}"

SEED="/input/seed.bin"
if [[ ! -f "$SEED" ]]; then
  echo "Seed not found at $SEED" >&2
  exit 2
fi

BIN="${TARGET_BIN:-/opt/target/bin/jq}"
if [[ ! -x "$BIN" ]]; then
  echo "Target binary not found or not executable: $BIN" >&2
  exit 3
fi

# Disable ASLR for this process only (not global)
ARCH="$(uname -m)"
if command -v setarch >/dev/null 2>&1; then
  timeout 10s setarch "$ARCH" -R "$BIN" . "$SEED"
else
  timeout 10s "$BIN" . "$SEED"
fi
