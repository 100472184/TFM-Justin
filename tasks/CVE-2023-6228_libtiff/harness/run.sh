#!/usr/bin/env bash
set -uo pipefail

# ASan: abort fast on memory errors
export ASAN_OPTIONS="abort_on_error=1:halt_on_error=1:fast_unwind_on_fatal=1:symbolize=0"

# UBSan: halt on undefined behavior
export UBSAN_OPTIONS="halt_on_error=1:symbolize=0"

SEED="/input/seed.bin"
if [[ ! -f "$SEED" ]]; then
  echo "Seed not found at $SEED" >&2
  exit 2
fi

BIN="${TARGET_BIN:-/opt/target/bin/tiffcp}"
if [[ ! -x "$BIN" ]]; then
  echo "Target binary not found or not executable: $BIN" >&2
  exit 3
fi

# Run tiffcp: copies/converts TIFF file
# No timeout wrapper - let Docker handle timeouts
"$BIN" "$SEED" /tmp/out.tiff 2>&1
