FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    git clang lld make cmake ninja-build python3 pkg-config \
    autoconf automake libtool ca-certificates \
    libpng-dev libbz2-dev zlib1g-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /src
RUN git clone https://gitlab.freedesktop.org/freetype/freetype.git . && \
    git checkout VER-2-10-3

ENV CC=clang
ENV CXX=clang++
ENV CFLAGS="-O1 -g -fno-omit-frame-pointer -fsanitize=address,undefined"
ENV CXXFLAGS="-O1 -g -fno-omit-frame-pointer -fsanitize=address,undefined"
ENV LDFLAGS="-fsanitize=address,undefined"

RUN ./autogen.sh && \
    ./configure --with-png=yes && \
    make -j$(nproc)

# ftbench is in builds/unix/
RUN mkdir -p /opt/target/bin && \
    if [ -f builds/unix/ftbench ]; then cp builds/unix/ftbench /opt/target/bin/; \
    else echo "ERROR: ftbench not found" >&2 && exit 1; fi

COPY harness/run.sh /harness/run.sh
RUN chmod +x /harness/run.sh

WORKDIR /work
ENTRYPOINT ["/harness/run.sh"]
